Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%environment
    export DEBIAN_FRONTEND=noninteractive

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -yq \
        build-essential \
        cmake \
        curl \
        git \
        ninja-build \
        wget \
        make

    # nle dependencies
    apt-get install -yq autoconf libtool pkg-config libbz2-dev

    mkdir conda_setup
    cd conda_setup
    curl -o miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
        chmod +x miniconda.sh && \
        ./miniconda.sh -b -p /opt/conda && \
        /opt/conda/bin/conda install -y python=3.10 && \
        /opt/conda/bin/conda clean -ya

%environment
    export PATH="/opt/conda/bin:$PATH"

%post 
    export PATH="/opt/conda/bin:$PATH"

    python -m pip install --upgrade pip
    pip install --upgrade setuptools

    conda update -n base -c defaults conda
    conda install -yq cmake flex bison lit

    pip install opencv-python toolz pyinstrument seaborn numba scipy
    pip install aicrowd-gym nltk
    pip install gymnasium
    
    # install NLE
    git clone https://github.com/BartekCupial/nle.git nle && cd nle \
    && git checkout fair_nle && git submodule init && git submodule update --recursive \
    && sed '/#define NLE_ALLOW_SEEDING 1/i#define NLE_ALLOW_SEEDING 1' include/nleobs.h -i \
    && sed '/self\.nethack\.set_initial_seeds = f/d' nle/env/tasks.py -i \
    && sed '/self\.nethack\.set_current_seeds = f/d' nle/env/tasks.py -i \
    && sed '/self\.nethack\.get_current_seeds = f/d' nle/env/tasks.py -i \
    && sed '/def seed(self, core=None, disp=None, reseed=True):/d' nle/env/tasks.py -i \
    && sed '/raise RuntimeError("NetHackChallenge doesn.t allow seed changes")/d' nle/env/tasks.py -i \
    && python setup.py install && cd .. 

    pip install nle-language-wrapper jsonline

    # install nle utils
    cd nle_utils && pip install -e . && cd ..

    # install mrunner
    pip install git+https://gitlab.com/awarelab/mrunner.git

    # Test NLE.
    python -c 'import gym; import nle; env = gym.make("NetHackScore-v0"); env.reset()'

    chmod a+rw -R /opt/conda/bin/python

    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec "$@"